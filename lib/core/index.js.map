{"version":3,"sources":["../../src/core/index.js"],"names":["debug","require","DOMInjected","Core","options","settings","template","DOMPropertyConfig","JSON","stringify","injectDOMPropertyConfig","tags","renderStatic","renderToFile","getValidator","component","renderToStaticMarkup","Promise","fulfill","reject","aphrodite","html","css","document","doctype","head","styles","content","scripts","metas","prettyPrint","ampValidations","validateMarkup","then","catch","ampErrors","validation","markup","error","file","toRender","staticMarkup","writeFileSync","err","Error","getInstance","instance","validator"],"mappings":"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","file":"index.js","sourcesContent":["import fs from 'fs'\nimport React from 'react'\nimport ReactDOMServer from 'react-dom/server'\nimport { DOMProperty } from 'react-dom/lib/ReactInjection'\nimport { StyleSheetServer } from 'aphrodite/no-important'\nimport { prettyPrint } from 'html'\nimport Tags, { getMetas, getScripts } from './Tags'\nimport ampValidator from '../utils/ampvalidator'\nimport Template from '../components/Template'\nimport DEFAULTS from './defaults'\nconst debug = require('debug')('rampt:core')\n\nlet DOMInjected = false\n/**\n * A class that manages ReactDOMServer & ModularCSS to\n * transpile ReactElements into a single valid AMP HTML document.\n * @param {Object} options - its defaults is a set of DOMProperty needed to\n * prevent React in ignore AMP's attrs and custom-elements.\n * @export\n * @constructor\n */\nclass Core {\n  constructor(options) {\n    this.settings = {\n      ...DEFAULTS,\n      ...options,\n      template: {\n        ...DEFAULTS.template,\n        ...options.template,\n      },\n      DOMPropertyConfig: {\n        ...DEFAULTS.DOMPropertyConfig,\n        ...options.DOMPropertyConfig,\n      }\n    }\n    debug('RAMPT settings: ', JSON.stringify(this.settings))\n    if (!DOMInjected) {\n      debug('Injecting AMP DOMProperties.')\n      DOMProperty.injectDOMPropertyConfig(this.settings.DOMPropertyConfig)\n      DOMInjected = true\n    } else {\n      debug('Custom DOMProperties were injected already')\n    }\n\n    this.tags = new Tags(this.settings.tags)\n    this.renderStatic = ::this.renderStatic\n    this.renderToFile = ::this.renderToFile\n    this.getValidator = ::this.getValidator\n  }\n\n  /**\n   * Aphrodite's css server-side rendering\n   * 'https://github.com/Khan/aphrodite'\n   * @param {ReactElement} component\n   * @returns {Object} - { css, html }\n   */\n  aphrodite(component) {\n    debug('Running aphrodite.')\n    return StyleSheetServer.renderStatic(() =>\n      ReactDOMServer.renderToStaticMarkup(component)\n    )\n  }\n\n  /**\n   * Creates a Promise and fulfills it with the given component rendered into a\n   * a valid AMP HTML document reduced to a single string.\n   * The component is allowed to contain childrens with custom AMP elements.\n   * @param {ReactElement} component - The component root to render into body.\n   * @param {Object} config - required and contains few optional\n   * parameters for AMP template.\n   * @returns {Promise[string]} - String that contains the static markup\n   */\n  renderStatic(component) {\n    const { template } = this.settings\n    return new Promise((fulfill, reject) => {\n      try {\n        const { html, css } = this.aphrodite(component)\n        debug('Executing reactDOMServer.')\n\n        let document = template.doctype +\n          ReactDOMServer.renderToStaticMarkup(\n            <Template\n              html={template.html}\n              head={{\n                ...template.head,\n                styles: css.content,\n                scripts: getScripts(),\n                metas: getMetas(),\n              }}\n              body={html}\n            />\n          )\n\n        if (template.prettyPrint) {\n          document = prettyPrint(document)\n        }\n\n        if (this.settings.ampValidations) {\n          debug('AMP validation is enabled.')\n          return this.validateMarkup(document)\n            .then(fulfill)\n            .catch((ampErrors)=> {\n              reject({ validation: ampErrors, markup: document })\n            })\n        }\n        return fulfill(document)\n      } catch (error) {\n        return reject({\n          markup: error\n        })\n      }\n    })\n  }\n\n  /**\n  * Calls for render and writes the content into disc.\n  * @param {String} output path.\n  * @param {ReactElement} component - The component root to render into body.\n  * @param {Object} config - required and contains few optional\n  * parameters for AMP template.\n  * @returns {Promise}\n  */\n  renderToFile(file, ...toRender) {\n    return this.renderStatic(...toRender)\n    .then((staticMarkup) => {\n      debug('Rendering to file --> ', file)\n      try {\n        fs.writeFileSync(file, staticMarkup)\n        return staticMarkup\n      } catch (err) {\n        throw new Error(err)\n      }\n    })\n  }\n\n  getValidator() {\n    debug('Waiting for validator.')\n    return ampValidator.getInstance()\n      .then((instance) => (this.validator = instance))\n      .then(() => (debug('Validator has arrived :).')))\n  }\n\n  validateMarkup(markup) {\n    debug('validating markup.')\n    return this.getValidator()\n      .then(() => {\n        this.validator.validateMarkup(markup)\n        return markup\n      })\n  }\n}\n\nexport default Core\n"]}